# configure alpine

# set the timezone to amsterdam
ln -sf /usr/share/zoneinfo/Europe/Amsterdam /etc/localtime
echo "Europe/Amsterdam" > /etc/timezone

# update and upgrade
apk update
apk upgrade

# install openssh and configure it, should be able to login as root with password
sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
sed -i 's/#PermitEmptyPasswords no/PermitEmptyPasswords yes/' /etc/ssh/sshd_config
rc-service sshd restart
rc-update add sshd

# install bash
apk add bash

# install sudo
apk add sudo
echo "root ALL=(ALL) ALL" > /etc/sudoers

# install ping, netcat, curl, wget, vim, git, bash
apk add iputils netcat-openbsd curl wget vim git bash

echo "Would you like to install k3s? (y/N)? "
read k3s
if [ -z "$k3s" ]; then
    k3s="n"
fi
if [ "$k3s" != "${k3s#[Yy]}" ] ;then
    # install k3s
    curl -sfL https://get.k3s.io | sh -
else
    echo "Skip k3s installation"
    return 0
    # # install CRIO, kubeadm, kubectl, kubelet
    # apk add crio kubeadm kubectl kubelet
    # rc-update add crio
    # rc-service crio start

    # # install kubernetes tools
    # curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.20.0/bin/linux/amd64/kubectl
    # chmod +x ./kubectl
    # mv ./kubectl /usr/local/bin/kubectl

    # # install and configure CNI
    # mkdir -p /opt/cni/bin
    # curl -L -o /opt/cni/bin/calico
    # curl -L -o /opt/cni/bin/calico-ipam
    # chmod +x /opt/cni/bin/calico
    # chmod +x /opt/cni/bin/calico-ipam

    # # install and configure kubelet
    # mkdir -p /etc/systemd/system/kubelet.service.d
    # echo "[Service]" > /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
    # echo "Environment=\"KUBELET_EXTRA_ARGS=--cgroup-driver=systemd\"" >> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
    # systemctl daemon-reload
    # systemctl enable kubelet
    # systemctl start kubelet

    # # install and configure kubeadm
    # mkdir -p /etc/systemd/system/kubelet.service.d
    # echo "[Service]" > /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
    # echo "Environment=\"KUBELET_EXTRA_ARGS=--cgroup-driver=systemd\"" >> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
    # systemctl daemon-reload
    # systemctl enable kubelet
    # systemctl start kubelet
fi